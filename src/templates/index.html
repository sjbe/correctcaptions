<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>News Photo Finder</title>
    <style>
      :root {
        --ink: #121419;
        --bg: #f2efe6;
        --panel: #ffffff;
        --accent: #12664f;
        --line: #d8d2c5;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: Georgia, Cambria, "Times New Roman", serif;
        color: var(--ink);
        background:
          radial-gradient(circle at top right, rgba(18,102,79,0.12), transparent 50%),
          linear-gradient(180deg, #f6f4ec 0%, var(--bg) 100%);
      }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 1rem; }
      .hero { margin: 1rem 0 1.25rem; }
      h1 { margin: 0 0 .4rem; font-size: clamp(1.5rem, 3.5vw, 2.4rem); }
      .sub { margin: 0; color: #484d56; }
      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 1rem;
        box-shadow: 0 12px 30px rgba(18,20,25,.07);
      }
      form.search-grid {
        display: grid;
        grid-template-columns: 1fr 220px 120px;
        gap: .75rem;
      }
      input, button {
        width: 100%;
        border-radius: 10px;
        border: 1px solid var(--line);
        padding: .68rem .72rem;
        font: inherit;
      }
      button {
        background: var(--accent);
        color: #fff;
        border: none;
        cursor: pointer;
      }
      .error {
        margin-top: .8rem;
        color: #8d1f12;
        font-weight: 600;
      }
      .warning {
        margin-top: .8rem;
        color: #7a5a00;
        font-weight: 600;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
      }
      th, td {
        border-bottom: 1px solid var(--line);
        padding: .7rem;
        text-align: left;
        vertical-align: top;
        font-size: .94rem;
      }
      th {
        background: #faf8f2;
        font-size: .88rem;
        text-transform: uppercase;
        letter-spacing: .05em;
      }
      a { color: #0c4f92; }
      .inline-form { margin: 0; }
      .link-btn {
        border: none;
        background: transparent;
        color: #0c4f92;
        text-decoration: underline;
        cursor: pointer;
        padding: 0;
        font: inherit;
      }
      .copy-btn {
        border: 1px solid var(--line);
        background: #f6f4ec;
        color: #1c2430;
        border-radius: 8px;
        padding: .35rem .55rem;
        font-size: .82rem;
        cursor: pointer;
      }
      img.thumb { width: 110px; max-height: 70px; object-fit: cover; border-radius: 8px; }
      @media (max-width: 840px) {
        form.search-grid { grid-template-columns: 1fr; }
        table, thead, tbody, tr, th, td { display: block; }
        tr { border: 1px solid var(--line); border-radius: 10px; margin: .75rem 0; }
        th { display: none; }
        td { border-bottom: none; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header class="hero">
        <h1>News Photo Finder</h1>
        <p class="sub">Search Getty + AP public pages and rewrite captions.</p>
      </header>

      <section class="panel">
        <form class="search-grid" action="/search" method="post">
          <input type="text" name="prompt" placeholder="Story prompt" value="{{ prompt }}" required />
          <input type="number" name="top" min="1" max="30" value="{{ top }}" />
          <button type="submit">Search</button>
        </form>

        {% if error %}
          <div class="error">{{ error }}</div>
        {% endif %}
        {% if warning %}
          <div class="warning">{{ warning }}</div>
        {% endif %}
      </section>

      {% if results %}
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Provider</th>
            <th>Score</th>
            <th>Date</th>
            <th>Edited Caption</th>
            <th>Copy</th>
            <th>Link</th>
            <th>Preview</th>
          </tr>
        </thead>
        <tbody>
          {% for r in results %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>
              {% if r.provider == "getty" %}
              <a href="{{ r.page_url }}" target="_blank" rel="noopener">{{ r.provider|upper }}</a>
              {% else %}
              {{ r.provider|upper }}
              {% endif %}
            </td>
            <td>{{ "%.3f"|format(r.score) }}</td>
            <td>{% if r.captured_at %}{{ r.captured_at.strftime('%Y-%m-%d') }}{% else %}unknown{% endif %}</td>
            <td>{{ r.edited_caption }}</td>
            <td>
              <button class="copy-btn" type="button" data-caption="{{ r.edited_caption|e }}">Copy caption</button>
            </td>
            <td>
              {% if r.provider == "getty" %}
              <a href="{{ r.page_url }}" target="_blank" rel="noopener">Open on Getty (login required)</a>
              {% else %}
              <a href="{{ r.page_url }}" target="_blank" rel="noopener">Open source</a>
              {% endif %}
            </td>
            <td>{% if r.image_url %}<img class="thumb" src="{{ r.image_url }}" alt="preview" />{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
    </div>
    <script>
      function fallbackCopy(text) {
        const area = document.createElement("textarea");
        area.value = text;
        area.style.position = "fixed";
        area.style.opacity = "0";
        document.body.appendChild(area);
        area.focus();
        area.select();
        document.execCommand("copy");
        document.body.removeChild(area);
      }

      document.querySelectorAll(".copy-btn").forEach((button) => {
        button.addEventListener("click", async () => {
          const caption = button.dataset.caption || "";
          try {
            if (navigator.clipboard && window.isSecureContext) {
              await navigator.clipboard.writeText(caption);
            } else {
              fallbackCopy(caption);
            }
            const prev = button.textContent;
            button.textContent = "Copied";
            setTimeout(() => { button.textContent = prev; }, 1000);
          } catch (_err) {
            button.textContent = "Copy failed";
            setTimeout(() => { button.textContent = "Copy caption"; }, 1200);
          }
        });
      });
    </script>
  </body>
</html>
